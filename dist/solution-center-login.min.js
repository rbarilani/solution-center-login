/*!
 * solution-center-login
 * https://github.com/zalando-incubator/solution-center-login
 * License: MIT
 */
function authenticationFactory(n,t,e,r,o,i,u,c,a){"use strict";function f(){return F.authenticate(encodeURIComponent(o.location.href))}function g(){return F.isAuthenticated()?(y(),n.reject()):n.when()}function s(n){return O(F.getToken(),n)}function l(t,e){return i.get("$http").post(r.getTokensAPI(B.getEnvironment()),{email:t,password:e,agent:U()}).then(function(t){return F.setToken(t.data),n.when(t.data)},function(){return n.reject("Wrong credentials")})}function h(t,e){return F.login(t,e).then(function(n){return O(n)},function(){return n.reject()})}function d(){return N(v())["catch"](function(){})["finally"](function(){return F.clearCredentials(),y(r.getLoginPath()),n.when()})}function m(){return N(v())["catch"](function(){})["finally"](function(){return F.clearCredentials(),n.when()})}function v(){return e.get(K)}function E(n){e.put(K,n,M())}function T(){return!!F.getUser()}function C(){return t.user}function A(){return e.get(_)}function k(n){e.put(_,n,M())}function I(){j(),D(),F.clearBrand()}function P(){e.remove(_,M())}function w(n){var t=r.getLoginPath();L(n)&&(t+="?redirect="+n),y(t)}function O(t,e){return S(t).then(function(t){return 200===t.status?($(t),n.when()):void 0},function(t){return 409===t.status?($(t),n.when()):(F.clearCredentials(),e&&w(e),n.reject())})}function S(t){if(!t)return n.reject("There is no token");var e=R(t);return e&&e.agent!==U()?n.reject("The current browser's user agent doesn't match the one stored in the token"):i.get("$http").get(r.getTokensAPI(B.getEnvironment()),{headers:{Authorization:t}})}function $(n){var t=n.headers().authorization;F.setToken(t),p(n.data)}function p(n){t.user=n}function j(){e.remove(K,M())}function D(){t.user=null}function N(n){return i.get("$http")["delete"](r.getTokensAPI(B.getEnvironment()),{headers:{Authorization:n}})}function R(n){return u.decodeToken(n)}function L(n){var t=r.getDomain(B.getEnvironment());return!!n&&-1!==n.indexOf(t)}function y(n){n=n||"/",B.isInternalCommunication()?a(function(){c.url(n)}):o.location.href=r.getSolutionCenterUrl(B.getEnvironment())+"/#"+n}function U(){return o.navigator.userAgent}function M(){var n=B.getEnvironment(),t=new Date;return{domain:n.DOMAIN,secure:"LOCAL"!==n.NAME,expires:new Date(t.getFullYear(),t.getMonth(),t.getDate()+7)}}var B=this,K="SC_TOKEN",_="SC_BRAND",F={requireAuthenticatedUser:f,redirectToHomeIfAuthenticated:g,authenticate:s,login:l,silentLogin:h,logout:d,silentLogout:m,getToken:v,setToken:E,isAuthenticated:T,getUser:C,getBrand:A,setBrand:k,clearCredentials:I,clearBrand:P,validateToken:S};return F}angular.module("sc-authentication",["ngStorage","ngCookies","angular-jwt","solutioncenter.communicator"]).config(["$localStorageProvider",function(n){n.setKeyPrefix("solutionCenter-")}]).provider("authenticationService",["scEnvironmentsProvider",function(n){"use strict";var t=!1;return{configEnvironment:function(t,e,r,o){var i=n.getSpecificEnvironment(t);return i.PORT=e||i.PORT,i.TOKEN_SERVICE=r||i.TOKEN_SERVICE,i.DOMAIN=o||i.DOMAIN,n.setCurrentEnvironment(i)},getEnvironment:function(){return n.getCurrentEnvironment()},setInternalCommunication:function(n){t=n},isInternalCommunication:function(){return t},$get:authenticationFactory}}]),authenticationFactory.$inject=["$q","$localStorage","$cookies","environmentsService","$window","$injector","jwtHelper","$location","$timeout"],angular.module("sc-authentication").factory("environmentsService",[function(){function n(n){var t=n.URL,e=n.PORT&&":".concat(n.PORT)||"";return t.concat(e)}function t(){return"/login"}function e(){return"/logout"}function r(n){return n.TOKEN_SERVICE+"/tokens"}function o(n){return n.DOMAIN}return{getSolutionCenterUrl:n,getLoginPath:t,getLogoutPath:e,getTokensAPI:r,getDomain:o}}]);