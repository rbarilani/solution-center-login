/*!
 * solution-center-login
 * https://github.com/zalando-incubator/solution-center-login
 * License: MIT
 */
function authenticationFactory(n,t,e,r,o,i,u,c,a){"use strict";function f(){return K.authenticate(encodeURIComponent(o.location.href))}function g(){return K.isAuthenticated()?(D(),n.reject()):n.when()}function s(n){return P(K.getToken(),n)}function l(t,e){return i.get("$http").post(r.getTokensAPI(U.getEnvironment()),{email:t,password:e,agent:L()}).then(function(t){return K.setToken(t.data),n.when(t.data)},function(){return n.reject("Wrong credentials")})}function h(t,e){return K.login(t,e).then(function(n){return P(n)},function(){return n.reject()})}function m(){return j(E())["catch"](function(){})["finally"](function(){return K.clearCredentials(),D(r.getLoginPath()),n.when()})}function d(){return j(E())["catch"](function(){})["finally"](function(){return K.clearCredentials(),n.when()})}function E(){return e.get(y)}function v(n){e.put(y,n,{domain:r.getDomain(U.getEnvironment())})}function T(){return!!K.getUser()}function N(){return t.user}function I(){return e.get(B)}function C(n){e.put(B,n,{domain:r.getDomain(U.getEnvironment())})}function O(){$(),p(),K.clearBrand()}function R(){e.remove(B)}function k(n){var t=r.getLoginPath();V(n)&&(t+="?redirect="+n),D(t)}function P(t,e){return A(t).then(function(t){return 200===t.status?(S(t),n.when()):void 0},function(t){return 409===t.status?(S(t),n.when()):(K.clearCredentials(),e&&k(e),n.reject())})}function A(t){if(!t)return n.reject("There is no token");var e=M(t);return e&&e.agent!==L()?n.reject("The current browser's user agent doesn't match the one stored in the token"):i.get("$http").get(r.getTokensAPI(U.getEnvironment()),t)}function S(n){var t=n.headers().authorization;K.setToken(t),w(n.data)}function w(n){t.user=n}function $(){e.remove(y)}function p(){t.user=null}function j(n){return i.get("$http")["delete"](r.getTokensAPI(U.getEnvironment()),{headers:{Authorization:n}})}function M(n){return u.decodeToken(n)}function V(n){var t=r.getDomain(U.getEnvironment());return!!n&&-1!==n.indexOf(t)}function D(n){n=n||"/",U.isInternalCommunication()?a(function(){c.url(n)}):o.location.href=r.getSolutionCenterUrl(U.getEnvironment())+"/#"+n}function L(){return o.navigator.userAgent}var U=this,y="SC_TOKEN",B="SC_BRAND",K={requireAuthenticatedUser:f,redirectToHomeIfAuthenticated:g,authenticate:s,login:l,silentLogin:h,logout:m,silentLogout:d,getToken:E,setToken:v,isAuthenticated:T,getUser:N,getBrand:I,setBrand:C,clearCredentials:O,clearBrand:R};return K}angular.module("sc-authentication",["ngStorage","ngCookies","angular-jwt","solution.center.communicator"]).config(["$localStorageProvider",function(n){n.setKeyPrefix("solutionCenter-")}]).provider("authenticationService",["environmentsProvider",function(n){"use strict";var t=!1;return{configEnvironment:function(t,e,r,o){var i=n.getCurrentEnvironment(t),u=n.formatEnvironment(i);return u.ENVIRONMENT.PORT=e||u.ENVIRONMENT.PORT,u.ENVIRONMENT.TOKEN_SERVICE=r||u.ENVIRONMENT.TOKEN_SERVICE,u.ENVIRONMENT.DOMAIN=o||u.ENVIRONMENT.DOMAIN,n.setCurrentEnvironment(u)},getEnvironment:function(){return n.getCurrentEnvironment()},setInternalCommunication:function(n){t=n},isInternalCommunication:function(){return t},$get:["$q","$localStorage","$cookies","environmentsService","$window","$injector","jwtHelper","$location","$timeout",authenticationFactory]}}]),angular.module("sc-authentication").factory("environmentsService",[function(){function n(n){var t=n.URL,e=n.PORT&&":".concat(n.PORT)||"";return t.concat(e)}function t(){return"/login"}function e(){return"/logout"}function r(n){return n.TOKEN_SERVICE+"/tokens"}function o(n){return n.DOMAIN}return{getSolutionCenterUrl:n,getLoginPath:t,getLogoutPath:e,getTokensAPI:r,getDomain:o}}]);